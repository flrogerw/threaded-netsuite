#!/usr/bin/php
<?php 

require_once( __DIR__ . DIRECTORY_SEPARATOR . 'Configure.php' );

$xxx = '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';
//echo(  decrypt(   $xxx  ) );

$xxx = '{"order":{"_source":"Fotobar Store 18","location":9,"department":8,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F162766","trandate":"11\/28\/2014","item":[{"addr1":"701 E foothill blvd #0305","city":"Azusa","state":"CA","zip":91702,"country":"US","phone":8082859609,"shipmethod":1011,"description":"Polaroid 3.5 x 4.25","item":1150,"_fulfilled_by":"","quantity":10,"custcol_page_count":10,"custcol_image_url":"http:\/\/www.polaroidfotobar.com\/pdf\/162766\/982419\/484dae0c\/982419.pdf","rate":1,"subtotal":10,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":"","attention":"Zabrina Zablan","addressee":"Zabrina Zablan"}],"taxtotal":"0.90","taxrate":9,"shippingcost":5.95,"handlingcost":"0","discounttotal":"0","total":16.85,"pnrefnum":"SO-083718","paymentmethod":"","_gcamount":"0","ismultishipto":true,"billaddress":"Zabrina Zablan\nZabrina Zablan\n701 E foothill blvd #0305\nAzusa CA 91702","shipaddress":"Zabrina Zablan\nZabrina Zablan\n701 E foothill blvd #0305\nAzusa CA 91702","shipdate":"12\/03\/2014","customform":132,"custbody_pos_trans_id":"SO-083718","custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F146176","firstname":"Zabrina","lastname":"Zablan","email":"zzablan11@apu.edu","isperson":true,"custentity_fotomail":"zabrina146176@myfotobar.com","_source":"Fotobar Store 18","custentitycustomer_department":8}}';
echo(  encrypt(   $xxx  ) );
die();

try{

	/** FIXES
	 Removed:
	 Backslashes from dates
	 "_itemlocation":"corporate"

	*/

	//Use GC
	//$sJson = '{"order":{"_source":"Fotobar Store 2","giftcertificateitem":[{"giftcertcode":"store405"}],"location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F74831","trandate":"03\/27\/2014","taxtotal":3.96,"taxrate":6,"shippingcost":0,"handlingcost":0,"discounttotal":0,"total":69.96,"pnrefnum":false,"paymentmethod":"","item":[{"shipmethod":10,"description":"Orange Shadowbox Polaroid 3.5 x 4.25","item":1197,"quantity":6,"rate":11,"subtotal":66,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":2}],"shipdate":"04\/01\/2014","customform":129,"ismultishipto":false,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F73242","firstname":"Jen","lastname":"Stone","email":"roger.williams@successories.com","isperson":true,"custentity_fotomail":"jen73242@myfotobar.com","_source":"Fotobar Store 2","addressee":"","custentitycustomer_department":2}}';

	// Buy GC
	//$sJson = '{"order":{"_source":"Fotobar Store 2","location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F74831","trandate":"03\/27\/2014","taxtotal":3.96,"taxrate":6,"shippingcost":0,"handlingcost":0,"discounttotal":0,"total":69.96,"pnrefnum":false,"paymentmethod":"","item":[{"giftcertrecipientname":"Roger Willliams","giftcertrecipientemail":"roger.williams@successories.com","giftcertnumber":"ROGERTEST","giftcertmessage":"Happy Birthday","giftcertfrom":"Roger Williams","shipmethod":10,"description":"Gift Certificate","item":1119,"quantity":1,"rate":50,"subtotal":50,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":2},{"shipmethod":10,"description":"Orange Shadowbox Polaroid 3.5 x 4.25","item":1197,"quantity":6,"rate":11,"subtotal":66,"custcol_produce_in_store":true,"custcol_store_pickup":false,"discounttotal":0,"location":2}],"shipdate":"04\/01\/2014","customform":129,"ismultishipto":false,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F73242","firstname":"Jen","lastname":"Stone","email":"roger.williams@successories.com","isperson":true,"custentity_fotomail":"jen73242@myfotobar.com","_source":"Fotobar Store 2","addressee":"","custentitycustomer_department":2}}';



	$pdo = new PDO('mysql:host='.SYSTEM_DB_HOST.';dbname='.SYSTEM_DB_DATABASE, SYSTEM_DB_USER, SYSTEM_DB_PASS);
	$stmt = $pdo->prepare('INSERT INTO fotobar_order_queue (customer_activa_id, order_activa_id, order_json) VALUES(:customer_activa_id, :order_activa_id, :order_json)');
	//$stmt->execute( array('customer_activa_id' => $aOrderData->customer->custentity_customer_source_id, ':order_activa_id' => $aOrderData->order->custbody_order_source_id, ':order_json' => encrypt( $sJson ) ) );
	$stmt->execute( array('customer_activa_id' => "F".rand(10000,90000), ':order_activa_id' => "FD".rand(10000,90000), ':order_json' => encrypt( $sJson ) ) );

} catch(PDOException $e) {
	echo 'Error: ' . $e->getMessage();
}



function encrypt( $sData ){

	$td = mcrypt_module_open('rijndael-128', '', 'ecb', '');
	$iv = mcrypt_create_iv( mcrypt_enc_get_iv_size( $td ), MCRYPT_RAND );
	$ks = mcrypt_enc_get_key_size( $td );
	$key = substr( md5( SECRET_KEY ), 0, $ks );
	mcrypt_generic_init( $td, $key, $iv );
	$encrypted = mcrypt_generic( $td, $sData );
	mcrypt_generic_deinit( $td );
	mcrypt_module_close( $td );

	return( base64_encode( $encrypted ) );
}

function decrypt( $sData ){

	$td = mcrypt_module_open( 'rijndael-128', '', 'ecb', '' );
	$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size( $td ), MCRYPT_RAND);
	$ks = mcrypt_enc_get_key_size( $td );
	$key = substr( md5( SECRET_KEY ), 0, $ks );

	mcrypt_generic_init( $td, $key, $iv );
	$decrypted = mdecrypt_generic( $td, base64_decode( $sData ) );
	$decrypted = rtrim($decrypted,"\0");
	mcrypt_generic_deinit( $td );
	mcrypt_module_close( $td );

	return( $decrypted );

}

