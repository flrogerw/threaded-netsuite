#!/usr/bin/php
<?php 

require_once( __DIR__ . DIRECTORY_SEPARATOR . 'Configure.php' );

$xxx = 'nx3arHBVbhV2elo6n7cdfxtP4agsbAatrt7wMlaF6Py9XSWMvYatcrzrzwfy6xK2IDXZjbTvZ15Ljqect9Lh6D4/JlwlXBWWMy8T6jIbeUFOXJCAxVwyVWonKVjVzY8IviIX3+FJnF+8EuqW68g67NXmItDBKy+n4staotJVWgiikV6e/2Vif9MH7YCkl06UYlznpJsiLIJHApt+iKqrNceu0QKZ+tW1s9RpBSbhN161D9aaKt8tuifPImfZ21D7xlD0iXYZRRe00Fg59yirYvygI+9C3wX0OIngmM1zfNlz+foY5ijT4MYXuydetWC0dENpLSoCnnfH2Da+zj+SsUsuiFjXs1PleScv33ptuNOSQIkcpDAG5vXOfEcWNz9pErbsAY8FO0HgKYhGX0nfimVlio/uEnKTT+RaJxaN158CpVr6w7rNsRC4PVbvGIvRWjM4ibSg9bU23sY18/3VTWbTv4io5a0gmZ9Ph/z/xe5PvzdSrnFjO7CTY4akE3oEM+pppRdCxWUP3vmHQnpekmOOJ0wv0ZE3jE8vZaAf5XhTpV2UtF2J3HnKV/WqwBISlMQve7c2UuhCJfaRJHm7PVz5h9bBOKWREYq73gr48Q1eAwszpXVzgEcMTFUKklnUzWcjV5cLpZZuy627GZqmHnvBMzng2DB1UeMdP3bQ/aE5uRII12uWc9rwpprR76ZOpcLbK4WUg975X1/lbTWEBhMjeTd5Fa7Sh4dEcuw5/MLLp4Ulc10ghbVSrVWxmXNOKoR0AsT7cZJcBHzfajXIP4PK4KmX/yPvWbKlvjGP6ZL/cgsFHioqDpvfFOooCd5hEwibYmwAQpriczgbhlmsjEijXq3cgXdKnAprsfunJhAmnNDZAO917VNQ2zR8EdsS7IcFM6oOMe1Q+qFw7SyuQ7U7LEUYBz8/uuSsS6jjvStmcJuYwB85zI/nfHvONdneCvv5A1U/JjQ74OHHvBvcmSTboCRUi6fd/LtWGhN4WqoDfaLHUxSozyd37OIwQ/QMWlsafR1eHd+XdGsWAe6gQ174okQF5ErDc8K2E2a7MScDTggyAWUTAn63F9CPSiL38GL/hB14cZEB4c3pPpVFcPGQRWqEjQDI44PaykH5vjT9fP3eHlYPftJxxE85G6dQdRjLu6ad5jc3zUJZk4V8mlH9I5u1E1+78wKHBJOPrWRkdxZpLfTgWo+RMqp6cGu2HBdTO6JmrNbAvO7Xq5hfsmKQJ+brhPUHAnbhyG2lRIdj/EWcilQMo8xHnmtL3Y0GP1rpzrOB92MXCV0z9zqEwWdZYS27iwttKvR50cIaeAnBeAzdj3R2cQyJyAooD2lElaxhhWHDo4+rb6fKEgiwcPbY8oYuJ0rItKvJ7qCBR349yvN6y1uO7Pf5k0U1Hd9tWNX6EPHb9hPAiGhf+6/zSyFDMsaHALhCJqXSXdC8kqRmEYdlLlP5WmHnwt7D6pK0ubuWJoUTj2xDc1IZsetwv1IA62N5MnTPBFZcNJ60vHgJQEe562OxI8X/IoXt+yPblnVguPBD/71QdCgCNNMfMuNrLquKN5X5JISg4PJuJ1wRyFMoux5jSVQRfciRifLljW721hekgzEoqq/yMFOJ0Pp5oSPaHlcMV5MuPf3jtzhdLh6NaHFZ1dASNnVMDRxIP9REBBp4i672jlTSUyuA8gNd8mckqCGB7f/HCLeZ7gBThS2MdYQBXzg938UNRBwvukV0SkzddG5RstouQbzMKIZd5ZG4Mducini0n/RZsjnlZ9YjkHP5h3vYfYy0WwPBfaPKh6kjP7wnNzVMw5nobb2RJD6u6TEqxzwlSrkRXbuQ4tsAS0SXZhlSzVMEkC9Ylbj4C4qDVNu0QuuuPJ+dH/c08uaUiZy4E01chyJJq0Pi1j7xTLHImJPUc0SsDG35';
//echo(  decrypt(   $xxx  ) );

$xxx = '{"order":{"_source":"Fotobar","location":1,"department":1,"leadsource":-6,"custbody_order_source":1,"ccprocessor":1,"custbody_order_source_id":"F169580","trandate":"12\/14\/2014","item":[{"shipmethod":1011,"addr1":"2375 Emerald Heights Court","city":"Reston","zip":20191, "state":"VA","phone":5712462049,"description":"Polaroid 3.5 x 4.25","item":1150,"_fulfilled_by":10,"quantity":1,"custcol_page_count":1,"custcol_image_url":"http:\/\/www.polaroidfotobar.com\/pdf\/169580\/1036235\/fbdcf225\/1036235.pdf","rate":1,"subtotal":1,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":10,"attention":"Amanda Seligman","addressee":"Amanda Seligman"}],"taxtotal":"0","taxrate":"0","shippingcost":"0.00","handlingcost":"0","discounttotal":-1,"total":"0.00","pnrefnum":false,"_gcamount":"0","_promocode":"GAP44949849489","ismultishipto":false,"discountitem":1164,"discountrate":-1,"shipmethod":1011,"shipaddress":"Amanda Seligman\nAmanda Seligman\n2375 Emerald Heights Court\nReston, VA 20191","shipdate":"12\/17\/2014","customform":107,"billaddress":"  ","custbody_web_discount_code":""},"customer":{"custentity_customer_source":1,"custentity_customer_source_id":"F151404","firstname":"Amanda","lastname":"Seligman","email":"assligm@gmail.con","isperson":true,"custentity_fotomail":"amanda151404@myfotobar.com","_source":"Fotobar","custentitycustomer_department":1}}';
echo( encrypt($xxx));
die();

try{

	/** FIXES
	 Removed:
	 Backslashes from dates
	 "_itemlocation":"corporate"

	*/

	//Use GC
	//$sJson = '{"order":{"_source":"Fotobar Store 2","giftcertificateitem":[{"giftcertcode":"store405"}],"location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F74831","trandate":"03\/27\/2014","taxtotal":3.96,"taxrate":6,"shippingcost":0,"handlingcost":0,"discounttotal":0,"total":69.96,"pnrefnum":false,"paymentmethod":"","item":[{"shipmethod":10,"description":"Orange Shadowbox Polaroid 3.5 x 4.25","item":1197,"quantity":6,"rate":11,"subtotal":66,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":2}],"shipdate":"04\/01\/2014","customform":129,"ismultishipto":false,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F73242","firstname":"Jen","lastname":"Stone","email":"roger.williams@successories.com","isperson":true,"custentity_fotomail":"jen73242@myfotobar.com","_source":"Fotobar Store 2","addressee":"","custentitycustomer_department":2}}';

	// Buy GC
	//$sJson = '{"order":{"_source":"Fotobar Store 2","location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F74831","trandate":"03\/27\/2014","taxtotal":3.96,"taxrate":6,"shippingcost":0,"handlingcost":0,"discounttotal":0,"total":69.96,"pnrefnum":false,"paymentmethod":"","item":[{"giftcertrecipientname":"Roger Willliams","giftcertrecipientemail":"roger.williams@successories.com","giftcertnumber":"ROGERTEST","giftcertmessage":"Happy Birthday","giftcertfrom":"Roger Williams","shipmethod":10,"description":"Gift Certificate","item":1119,"quantity":1,"rate":50,"subtotal":50,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":2},{"shipmethod":10,"description":"Orange Shadowbox Polaroid 3.5 x 4.25","item":1197,"quantity":6,"rate":11,"subtotal":66,"custcol_produce_in_store":true,"custcol_store_pickup":false,"discounttotal":0,"location":2}],"shipdate":"04\/01\/2014","customform":129,"ismultishipto":false,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F73242","firstname":"Jen","lastname":"Stone","email":"roger.williams@successories.com","isperson":true,"custentity_fotomail":"jen73242@myfotobar.com","_source":"Fotobar Store 2","addressee":"","custentitycustomer_department":2}}';



	$pdo = new PDO('mysql:host='.SYSTEM_DB_HOST.';dbname='.SYSTEM_DB_DATABASE, SYSTEM_DB_USER, SYSTEM_DB_PASS);
	$stmt = $pdo->prepare('INSERT INTO fotobar_order_queue (customer_activa_id, order_activa_id, order_json) VALUES(:customer_activa_id, :order_activa_id, :order_json)');
	//$stmt->execute( array('customer_activa_id' => $aOrderData->customer->custentity_customer_source_id, ':order_activa_id' => $aOrderData->order->custbody_order_source_id, ':order_json' => encrypt( $sJson ) ) );
	$stmt->execute( array('customer_activa_id' => "F".rand(10000,90000), ':order_activa_id' => "FD".rand(10000,90000), ':order_json' => encrypt( $sJson ) ) );

} catch(PDOException $e) {
	echo 'Error: ' . $e->getMessage();
}



function encrypt( $sData ){

	$td = mcrypt_module_open('rijndael-128', '', 'ecb', '');
	$iv = mcrypt_create_iv( mcrypt_enc_get_iv_size( $td ), MCRYPT_RAND );
	$ks = mcrypt_enc_get_key_size( $td );
	$key = substr( md5( SECRET_KEY ), 0, $ks );
	mcrypt_generic_init( $td, $key, $iv );
	$encrypted = mcrypt_generic( $td, $sData );
	mcrypt_generic_deinit( $td );
	mcrypt_module_close( $td );

	return( base64_encode( $encrypted ) );
}

function decrypt( $sData ){

	$td = mcrypt_module_open( 'rijndael-128', '', 'ecb', '' );
	$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size( $td ), MCRYPT_RAND);
	$ks = mcrypt_enc_get_key_size( $td );
	$key = substr( md5( SECRET_KEY ), 0, $ks );

	mcrypt_generic_init( $td, $key, $iv );
	$decrypted = mdecrypt_generic( $td, base64_decode( $sData ) );
	$decrypted = rtrim($decrypted,"\0");
	mcrypt_generic_deinit( $td );
	mcrypt_module_close( $td );

	return( $decrypted );

}

