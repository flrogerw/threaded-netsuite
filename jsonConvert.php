#!/usr/bin/php
<?php 

require_once( __DIR__ . DIRECTORY_SEPARATOR . 'Configure.php' );


$xxx = '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';
echo(  decrypt(   $xxx  ) );

die();

$xxx = '{"order":{"_source":"Fotobar","location":1,"department":1,"leadsource":-6,"custbody_order_source":1,"ccprocessor":1,"custbody_order_source_id":"F184327","trandate":"01\/04\/2015","item":[{"addr1":"6015 State Bridge Road","addr2":"Apt. 9306","city":"Johns Creek","state":"GA","zip":30097,"country":"US","phone":4045567230,"shipmethod":1011,"description":"Polaroid 3.5 x 4.25","item":1150,"_fulfilled_by":10,"quantity":6,"custcol_page_count":6,"custcol_image_url":"http:\/\/www.polaroidfotobar.com\/pdf\/184327\/1159912\/44a09756\/1159912.pdf","rate":1,"subtotal":6,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":10,"attention":"Olivia  Moody","addressee":"Olivia  Moody"}],"taxtotal":"0.00","taxrate":"0","shippingcost":5.95,"handlingcost":"0","discounttotal":"0","total":11.95,"pnrefnum":"4203518725300176326795","authcode":219076,"paymentmethod":6,"ccname":"Harrison Smith","ccnumber":"379739491601007","_gcamount":"0","ismultishipto":false,"shipmethod":1011,"shipaddress":"Olivia  Moody\nOlivia  Moody\n6015 State Bridge Road\nApt. 9306\nJohns Creek GA 30097","ccexpiredate":"04\/2017","cczipcode":85260,"shipdate":"01\/07\/2015","customform":107,"billaddress":"Harrison Smith\nHarrison Smith\n9494 E. Redfield Road\nApt. 2080\nScottsdale AZ 85260","custbody_web_discount_code":""},"customer":{"custentity_customer_source":1,"custentity_customer_source_id":"F162432","firstname":"Harrison","lastname":"Smith","email":"harrison.smith.88@gmail.com","isperson":true,"custentity_fotomail":"harrison162432@myfotobar.com","addressbook":{"billing":{"addr1":"9494 E. Redfield Road","addr2":"Apt. 2080","city":"Scottsdale","state":"AZ","zip":85260,"country":"US","phone":4045567230,"addressee":"Harrison Smith"}},"_source":"Fotobar","custentitycustomer_department":1}}';

//$xxx = '{"order":{"_source":"Fotobar","location":1,"department":1,"leadsource":-6,"custbody_order_source":1,"ccprocessor":1,"custbody_order_source_id":"F170426","trandate":"12\/16\/2014","item":[{"addr1":"21411 partha way","city":"Houston","state":"TX","zip":77073,"country":"US","phone":9132212549,"shipmethod":1011,"description":"Clothesline Frame with Clips","item":318,"_fulfilled_by":"0","quantity":1,"custcol_page_count":1,"rate":50,"subtotal":50,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":1,"attention":"Gia Beaver","addressee":"\'Cake\' by Gia Genea","isresidential":false},{"addr1":"21411 partha way","city":"Houston","state":"TX","zip":77073,"country":"US","phone":9132212549,"shipmethod":1011,"description":"Polaroid 3.5 x 4.25","item":1150,"_fulfilled_by":10,"quantity":19,"custcol_page_count":19,"custcol_image_url":"http:\/\/www.polaroidfotobar.com\/pdf\/170426\/1042956\/5ad214d3\/1042956.pdf","rate":1,"subtotal":19,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":10,"attention":"Gia Beaver","addressee":"\'Cake\' by Gia Genea","isresidential":false}],"taxtotal":"0.00","taxrate":"0","shippingcost":14.95,"handlingcost":"0","discounttotal":"0","total":83.95,"pnrefnum":"4187563090670176327037","authcode":810200,"paymentmethod":4,"ccname":"Gia Beaver","ccnumber":"5581588946234317","_gcamount":"0","ismultishipto":false,"shipmethod":1011,"shipaddress":"Gia Beaver\n\'Cake\' by Gia Genea\n21411 partha way\nHouston TX 77073","ccexpiredate":"07\/2015","cczipcode":77073,"shipdate":"12\/19\/2014","customform":107,"billaddress":"\'Cake\' by Gia Genea\n\'Cake\' by Gia Genea\n21411 partha way\nHouston TX 77073","custbody_web_discount_code":""},"customer":{"custentity_customer_source":1,"custentity_customer_source_id":"F151944","firstname":"Gia","lastname":"Beaver","email":"Gia.Genea@gmail.com","isperson":true,"custentity_fotomail":"gia151944@myfotobar.com","addressbook":{"billing":{"companyname":"\'Cake\' by Gia Genea","addr1":"21411 partha way","city":"Houston","state":"TX","zip":77073,"country":"US","phone":9132212549,"addressee":"\'Cake\' by Gia Genea","isresidential":false}},"_source":"Fotobar","custentitycustomer_department":1}}';
echo( encrypt($xxx));
die();

try{

	/** FIXES
	 Removed:
	 Backslashes from dates
	 "_itemlocation":"corporate"

	*/

	//Use GC
	//$sJson = '{"order":{"_source":"Fotobar Store 2","giftcertificateitem":[{"giftcertcode":"store405"}],"location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F74831","trandate":"03\/27\/2014","taxtotal":3.96,"taxrate":6,"shippingcost":0,"handlingcost":0,"discounttotal":0,"total":69.96,"pnrefnum":false,"paymentmethod":"","item":[{"shipmethod":10,"description":"Orange Shadowbox Polaroid 3.5 x 4.25","item":1197,"quantity":6,"rate":11,"subtotal":66,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":2}],"shipdate":"04\/01\/2014","customform":129,"ismultishipto":false,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F73242","firstname":"Jen","lastname":"Stone","email":"roger.williams@successories.com","isperson":true,"custentity_fotomail":"jen73242@myfotobar.com","_source":"Fotobar Store 2","addressee":"","custentitycustomer_department":2}}';

	// Buy GC
	//$sJson = '{"order":{"_source":"Fotobar Store 2","location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F74831","trandate":"03\/27\/2014","taxtotal":3.96,"taxrate":6,"shippingcost":0,"handlingcost":0,"discounttotal":0,"total":69.96,"pnrefnum":false,"paymentmethod":"","item":[{"giftcertrecipientname":"Roger Willliams","giftcertrecipientemail":"roger.williams@successories.com","giftcertnumber":"ROGERTEST","giftcertmessage":"Happy Birthday","giftcertfrom":"Roger Williams","shipmethod":10,"description":"Gift Certificate","item":1119,"quantity":1,"rate":50,"subtotal":50,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":2},{"shipmethod":10,"description":"Orange Shadowbox Polaroid 3.5 x 4.25","item":1197,"quantity":6,"rate":11,"subtotal":66,"custcol_produce_in_store":true,"custcol_store_pickup":false,"discounttotal":0,"location":2}],"shipdate":"04\/01\/2014","customform":129,"ismultishipto":false,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F73242","firstname":"Jen","lastname":"Stone","email":"roger.williams@successories.com","isperson":true,"custentity_fotomail":"jen73242@myfotobar.com","_source":"Fotobar Store 2","addressee":"","custentitycustomer_department":2}}';



	$pdo = new PDO('mysql:host='.SYSTEM_DB_HOST.';dbname='.SYSTEM_DB_DATABASE, SYSTEM_DB_USER, SYSTEM_DB_PASS);
	$stmt = $pdo->prepare('INSERT INTO fotobar_order_queue (customer_activa_id, order_activa_id, order_json) VALUES(:customer_activa_id, :order_activa_id, :order_json)');
	//$stmt->execute( array('customer_activa_id' => $aOrderData->customer->custentity_customer_source_id, ':order_activa_id' => $aOrderData->order->custbody_order_source_id, ':order_json' => encrypt( $sJson ) ) );
	$stmt->execute( array('customer_activa_id' => "F".rand(10000,90000), ':order_activa_id' => "FD".rand(10000,90000), ':order_json' => encrypt( $sJson ) ) );

} catch(PDOException $e) {
	echo 'Error: ' . $e->getMessage();
}



function encrypt( $sData ){

	$td = mcrypt_module_open('rijndael-128', '', 'ecb', '');
	$iv = mcrypt_create_iv( mcrypt_enc_get_iv_size( $td ), MCRYPT_RAND );
	$ks = mcrypt_enc_get_key_size( $td );
	$key = substr( md5( SECRET_KEY ), 0, $ks );
	mcrypt_generic_init( $td, $key, $iv );
	$encrypted = mcrypt_generic( $td, $sData );
	mcrypt_generic_deinit( $td );
	mcrypt_module_close( $td );

	return( base64_encode( $encrypted ) );
}

function decrypt( $sData ){

	$td = mcrypt_module_open( 'rijndael-128', '', 'ecb', '' );
	$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size( $td ), MCRYPT_RAND);
	$ks = mcrypt_enc_get_key_size( $td );
	$key = substr( md5( SECRET_KEY ), 0, $ks );

	mcrypt_generic_init( $td, $key, $iv );
	$decrypted = mdecrypt_generic( $td, base64_decode( $sData ) );
	$decrypted = rtrim($decrypted,"\0");
	mcrypt_generic_deinit( $td );
	mcrypt_module_close( $td );

	return( $decrypted );

}

