#!/usr/bin/php
<?php 

require_once( __DIR__ . DIRECTORY_SEPARATOR . 'Configure.php' );

$xxx= '+k1NxpGrKttJ+GNf7rML41hpWwL6+4wq5JInbmIafy5hDxCZwuLHZnDCw6booGkTEDIjAKv1L0BxzEKcn5hSPwUw4TLqwkRT1hkNis9SWzBJQiA2QYywD6wZvjQWS3e6snHBmDUKYh81GSI4QcPBXLxVn8YDEmSICji3r0RqLulcSWwLsjxIEvJqheQ/v1N/VIciok2A7MTw2qBdbezgce7J+Qce9m8cYtC1wv2eo6r7imlKv9Hub81Too1D9ka9Z5GDbCnPbgMiPspsAycBgg3HX+in7OUiNI2IWiCSlyeIaD1q4PK2/8sO5Ur6qR0gAr9f/0ve+xhK+SN0RZofV7oeTt1Q5gEVAQhpilRD2h4txClQCcI4QY26+NUqo6FT/+QsR1gWr5s2b63J24nUrpjLavSsodgCkva3cEqrd4YmgXNwFYvIm6tt/ZRm+o8LjOCjZf2i6CnvDcOZR3T8GSMH+4TZtENdWBbLUZNDcCKjLybwAcSbK7xEWwkROtqZaZdfzyw8/KUiC0n1ETk5gQ2M58zbMWeaDISHJYGZzizy5JzlyHt1j52xlsaxlhyz9HZBZLiy40Ws68YvXvL9fVZj8gW1BsyTImFfba4vPQw+tOOYVMdGqzYP1WDsrzy1fe5pS8PVL0vKnclBTEUJPyflp5khzRnEIwvIzx19gbnSBVFjWzkeBDcZ5cnB1yihjg3QaA7jS+//OLHu/z1vweCt+cQk+ptST5tIG3yLUEV0zmRZ+fByYk0EHo7Jz1WExCz6XRdDA7WSzzhmFX1uOSwEzVzjilx+KngLaaTn97D4Wo2tTaNzz1xMuAO8PGbhRYVwKNAzX2rXikWtFZ0RpVaxXDwgkdTVxO75tkdqnWkUUJIGI+Mizey7vU20gWbNWGlbAvr7jCrkkiduYhp/LmEPEJnC4sdmcMLDpuigaRMQMiMAq/UvQHHMQpyfmFI/BTDhMurCRFPWGQ2Kz1JbMElCIDZBjLAPrBm+NBZLd7odYNk6D+rxlgAeNWS30dolZddkwl3O8Sp626jQ2EVBkNsQQvWDd18e1XaJqbt5tIHpHNBWA2F1Ut+aEFnqir3qDEpUQXyv3+iwU0hQ92Svf4HzOrR2PGInaFIpx9AvMXs9NmomXDpguR9iR3JYP7bT8B/1felO/ND9idjVbY+brgr9BuE/Ml9ivdVF0/GsxOHVxYPFkityCm3k/40TJVT9lnVguPBD/71QdCgCNNMfMtMxKjYWhd/7reEGfcR6WrgDT23uDQFwHIvJWfpum+ZZwPVdSdIRsvCagmF8zmveb1H23qMCRthF0WgQ04RchNSg11S5TJ/Kkb8oo/cRYwRLJ8tzoUnbBNv5tGT++cvUV4FeCYmVuU7uuaDzIUlKPglqFus9LkmGPARBWSDJ24WTayzs2aLna91pbIMJlsro5GWdT4M4GGclYUxmFFfTigvYTNFiAzku6RRowB4qnJUnmDGO+JYeRcxsGQlkVGVEXWaxtafU7OcASXGiMriy5QJluPpUEOHjwsMe9RhvJLMRtBi8xUUwegbX+5yX9aVpBSZQ/UhP4ox/hRzWG09kb18jeQIVygH+uQAzSPw7i+uTTeNhtkGebMaOAJT2q3BF43R4BJd+XEQASlrsJYqVxbM=';
echo(  decrypt(   $xxx  ) );

die();


$xxx = '{"order":{"_source":"Fotobar Store 2","location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F200083","trandate":"02\/05\/2015","entity":451779,"item":[{"addr1":"Polaroid Fotobar - F200083","addr2":"14851 Lyons Road #100","city":"Delray Beach","state":"FL","zip":33446,"country":"US","phone":"561-212-7752","shipmethod":2889,"description":"8\"x8\" Metal Print with easel","item":3211,"_fulfilled_by":"0","custcol162":1,"quantity":1,"custcol_page_count":1,"custcol_image_url":"http:\/\/www.polaroidfotobar.com\/pdf\/200083\/1280899\/174dda2c\/1280899.pdf","rate":35,"subtotal":35,"custcol_produce_in_store":false,"custcol_store_pickup":true,"discounttotal":0,"custbody_comments":"Image Quality: Low - 75","location":1,"attention":"Francis Donahue","addressee":"Francis Donahue"}],"taxtotal":2.1,"taxrate":6,"shippingcost":"0.00","handlingcost":"0","discounttotal":"0","total":37.1,"pnrefnum":false,"paymentmethod":"","_gcamount":"0","ismultishipto":true,"billaddress":"Francis Donahue\nFrancis Donahue\nPolaroid Fotobar - F200083\n14851 Lyons Road #100\nDelray Beach FL 33446","shipaddress":"Francis Donahue\nFrancis Donahue\nPolaroid Fotobar - F200083\n14851 Lyons Road #100\nDelray Beach FL 33446","shipdate":"02\/10\/2015","customform":129,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F49382","firstname":"J","lastname":"Smith","email":"pcustomers@yahoo.com","isperson":true,"custentity_fotomail":"j49382@myfotobar.com","_source":"Fotobar Store 2","custentitycustomer_department":2,"entityid":451779}}';


var_dump(json_decode($xxx));

die();
$xxx = '{"order":{"_source":"Fotobar","location":1,"department":1,"leadsource":-6,"custbody_order_source":1,"ccprocessor":1,"custbody_order_source_id":"F196330","trandate":"01\/25\/2015","item":[{"addr1":"833 Market Street","addr2":"Suite 616","city":"San Francisco","state":"CA","zip":94103,"country":"US","phone":3235518692,"shipmethod":1012,"description":"Polaroid 3.5 x 4.25","item":1150,"_fulfilled_by":10,"quantity":25,"custcol_page_count":25,"custcol_image_url":"http:\/\/www.polaroidfotobar.com\/pdf\/196330\/1246739\/df43f884\/1246739.pdf","rate":1,"subtotal":25,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":10,"attention":"Anna Briet","addressee":"Fiax Lux","isresidential":false}],"taxtotal":2.19,"taxrate":8.75,"shippingcost":14.95,"handlingcost":"0","discounttotal":"0","total":42.14,"pnrefnum":"4222161299970176326799","authcode":"000215","paymentmethod":5,"ccname":"Pilar Gonzalez","ccnumber":"4411037124296531","_gcamount":"0","ismultishipto":false,"shipmethod":1012,"shipaddress":"Anna Briet\nFiax Lux\n833 Market Street\nSuite 616\nSan Francisco CA 94103","ccexpiredate":"01\/2017","cczipcode":94107,"shipdate":"01\/28\/2015","customform":107,"billaddress":"Pilar Gonzalez\nPilar Gonzalez\n1 Saint Francis Pl\nApt. 5107\nSan Francisco CA 94107","custbody_web_discount_code":""},"customer":{"custentity_customer_source":1,"custentity_customer_source_id":"F173398","firstname":"Pilar","lastname":"Gonzalez","email":"Pilar_ags@msn.com","isperson":true,"custentity_fotomail":"pilar173398@myfotobar.com","addressbook":{"billing":{"addr1":"1 Saint Francis Pl","addr2":"Apt. 5107","city":"San Francisco","state":"CA","zip":94107,"country":"US","phone":9568020058,"addressee":"Pilar Gonzalez"}},"_source":"Fotobar","custentitycustomer_department":1}}';
//$xxx = '{"order":{"_source":"Fotobar","location":1,"department":1,"leadsource":-6,"custbody_order_source":1,"ccprocessor":1,"custbody_order_source_id":"F170426","trandate":"12\/16\/2014","item":[{"addr1":"21411 partha way","city":"Houston","state":"TX","zip":77073,"country":"US","phone":9132212549,"shipmethod":1011,"description":"Clothesline Frame with Clips","item":318,"_fulfilled_by":"0","quantity":1,"custcol_page_count":1,"rate":50,"subtotal":50,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":1,"attention":"Gia Beaver","addressee":"\'Cake\' by Gia Genea","isresidential":false},{"addr1":"21411 partha way","city":"Houston","state":"TX","zip":77073,"country":"US","phone":9132212549,"shipmethod":1011,"description":"Polaroid 3.5 x 4.25","item":1150,"_fulfilled_by":10,"quantity":19,"custcol_page_count":19,"custcol_image_url":"http:\/\/www.polaroidfotobar.com\/pdf\/170426\/1042956\/5ad214d3\/1042956.pdf","rate":1,"subtotal":19,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":10,"attention":"Gia Beaver","addressee":"\'Cake\' by Gia Genea","isresidential":false}],"taxtotal":"0.00","taxrate":"0","shippingcost":14.95,"handlingcost":"0","discounttotal":"0","total":83.95,"pnrefnum":"4187563090670176327037","authcode":810200,"paymentmethod":4,"ccname":"Gia Beaver","ccnumber":"5581588946234317","_gcamount":"0","ismultishipto":false,"shipmethod":1011,"shipaddress":"Gia Beaver\n\'Cake\' by Gia Genea\n21411 partha way\nHouston TX 77073","ccexpiredate":"07\/2015","cczipcode":77073,"shipdate":"12\/19\/2014","customform":107,"billaddress":"\'Cake\' by Gia Genea\n\'Cake\' by Gia Genea\n21411 partha way\nHouston TX 77073","custbody_web_discount_code":""},"customer":{"custentity_customer_source":1,"custentity_customer_source_id":"F151944","firstname":"Gia","lastname":"Beaver","email":"Gia.Genea@gmail.com","isperson":true,"custentity_fotomail":"gia151944@myfotobar.com","addressbook":{"billing":{"companyname":"\'Cake\' by Gia Genea","addr1":"21411 partha way","city":"Houston","state":"TX","zip":77073,"country":"US","phone":9132212549,"addressee":"\'Cake\' by Gia Genea","isresidential":false}},"_source":"Fotobar","custentitycustomer_department":1}}';
echo( encrypt($xxx));
die();

try{

	/** FIXES
	 Removed:
	 Backslashes from dates
	 "_itemlocation":"corporate"

	*/

	//Use GC
	//$sJson = '{"order":{"_source":"Fotobar Store 2","giftcertificateitem":[{"giftcertcode":"store405"}],"location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F74831","trandate":"03\/27\/2014","taxtotal":3.96,"taxrate":6,"shippingcost":0,"handlingcost":0,"discounttotal":0,"total":69.96,"pnrefnum":false,"paymentmethod":"","item":[{"shipmethod":10,"description":"Orange Shadowbox Polaroid 3.5 x 4.25","item":1197,"quantity":6,"rate":11,"subtotal":66,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":2}],"shipdate":"04\/01\/2014","customform":129,"ismultishipto":false,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F73242","firstname":"Jen","lastname":"Stone","email":"roger.williams@successories.com","isperson":true,"custentity_fotomail":"jen73242@myfotobar.com","_source":"Fotobar Store 2","addressee":"","custentitycustomer_department":2}}';

	// Buy GC
	//$sJson = '{"order":{"_source":"Fotobar Store 2","location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F74831","trandate":"03\/27\/2014","taxtotal":3.96,"taxrate":6,"shippingcost":0,"handlingcost":0,"discounttotal":0,"total":69.96,"pnrefnum":false,"paymentmethod":"","item":[{"giftcertrecipientname":"Roger Willliams","giftcertrecipientemail":"roger.williams@successories.com","giftcertnumber":"ROGERTEST","giftcertmessage":"Happy Birthday","giftcertfrom":"Roger Williams","shipmethod":10,"description":"Gift Certificate","item":1119,"quantity":1,"rate":50,"subtotal":50,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":2},{"shipmethod":10,"description":"Orange Shadowbox Polaroid 3.5 x 4.25","item":1197,"quantity":6,"rate":11,"subtotal":66,"custcol_produce_in_store":true,"custcol_store_pickup":false,"discounttotal":0,"location":2}],"shipdate":"04\/01\/2014","customform":129,"ismultishipto":false,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F73242","firstname":"Jen","lastname":"Stone","email":"roger.williams@successories.com","isperson":true,"custentity_fotomail":"jen73242@myfotobar.com","_source":"Fotobar Store 2","addressee":"","custentitycustomer_department":2}}';



	$pdo = new PDO('mysql:host='.SYSTEM_DB_HOST.';dbname='.SYSTEM_DB_DATABASE, SYSTEM_DB_USER, SYSTEM_DB_PASS);
	$stmt = $pdo->prepare('INSERT INTO fotobar_order_queue (customer_activa_id, order_activa_id, order_json) VALUES(:customer_activa_id, :order_activa_id, :order_json)');
	//$stmt->execute( array('customer_activa_id' => $aOrderData->customer->custentity_customer_source_id, ':order_activa_id' => $aOrderData->order->custbody_order_source_id, ':order_json' => encrypt( $sJson ) ) );
	$stmt->execute( array('customer_activa_id' => "F".rand(10000,90000), ':order_activa_id' => "FD".rand(10000,90000), ':order_json' => encrypt( $sJson ) ) );

} catch(PDOException $e) {
	echo 'Error: ' . $e->getMessage();
}



function encrypt( $sData ){

	$td = mcrypt_module_open('rijndael-128', '', 'ecb', '');
	$iv = mcrypt_create_iv( mcrypt_enc_get_iv_size( $td ), MCRYPT_RAND );
	$ks = mcrypt_enc_get_key_size( $td );
	$key = substr( md5( SECRET_KEY ), 0, $ks );
	mcrypt_generic_init( $td, $key, $iv );
	$encrypted = mcrypt_generic( $td, $sData );
	mcrypt_generic_deinit( $td );
	mcrypt_module_close( $td );

	return( base64_encode( $encrypted ) );
}

function decrypt( $sData ){

	$td = mcrypt_module_open( 'rijndael-128', '', 'ecb', '' );
	$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size( $td ), MCRYPT_RAND);
	$ks = mcrypt_enc_get_key_size( $td );
	$key = substr( md5( SECRET_KEY ), 0, $ks );

	mcrypt_generic_init( $td, $key, $iv );
	$decrypted = mdecrypt_generic( $td, base64_decode( $sData ) );
	$decrypted = rtrim($decrypted,"\0");
	mcrypt_generic_deinit( $td );
	mcrypt_module_close( $td );

	return( $decrypted );

}

