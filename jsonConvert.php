#!/usr/bin/php
<?php 

require_once( __DIR__ . DIRECTORY_SEPARATOR . 'Configure.php' );

$xxx = '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';
echo(  decrypt(   $xxx  ) );

die();


$xxx = '{"order":{"_source":"Fotobar Store 2","location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F200083","trandate":"02\/05\/2015","entity":451779,"item":[{"addr1":"Polaroid Fotobar - F200083","addr2":"14851 Lyons Road #100","city":"Delray Beach","state":"FL","zip":33446,"country":"US","phone":"561-212-7752","shipmethod":2889,"description":"8\"x8\" Metal Print with easel","item":3211,"_fulfilled_by":"0","custcol162":1,"quantity":1,"custcol_page_count":1,"custcol_image_url":"http:\/\/www.polaroidfotobar.com\/pdf\/200083\/1280899\/174dda2c\/1280899.pdf","rate":35,"subtotal":35,"custcol_produce_in_store":false,"custcol_store_pickup":true,"discounttotal":0,"custbody_comments":"Image Quality: Low - 75","location":1,"attention":"Francis Donahue","addressee":"Francis Donahue"}],"taxtotal":2.1,"taxrate":6,"shippingcost":"0.00","handlingcost":"0","discounttotal":"0","total":37.1,"pnrefnum":false,"paymentmethod":"","_gcamount":"0","ismultishipto":true,"billaddress":"Francis Donahue\nFrancis Donahue\nPolaroid Fotobar - F200083\n14851 Lyons Road #100\nDelray Beach FL 33446","shipaddress":"Francis Donahue\nFrancis Donahue\nPolaroid Fotobar - F200083\n14851 Lyons Road #100\nDelray Beach FL 33446","shipdate":"02\/10\/2015","customform":129,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F49382","firstname":"J","lastname":"Smith","email":"pcustomers@yahoo.com","isperson":true,"custentity_fotomail":"j49382@myfotobar.com","_source":"Fotobar Store 2","custentitycustomer_department":2,"entityid":451779}}';


var_dump(json_decode($xxx));

die();

$xxx = '{"order":{"billaddress":"Polaroid Fotobar\nPolaroid Fotobar\n6000 Glades Road #1032C\nBoca Raton FL 33431","ccprocessor":1,"custbody_order_source":28,"custbody_order_source_id":"F219447","custbody_pos_auth_code":"138273","custbody_pos_cc_exp_date":"02\/2018","custbody_pos_cc_number":"**** **** **** 4049","custbody_pos_cc_total":132.5,"custbody_pos_employee":"Alex Berger","custbody_pos_invoice":64324736,"custbody_pos_location":"Boca Town Center","custbody_pos_postranstime":"12:54 pm","custbody_pos_receipt":26043118,"custbody_pos_receipt_date":"02\/23\/2015 12:54:40 pm","custbody_pos_receipt_total":132.5,"custbody_pos_ref_num":"6947169434","custbody_pos_tax_total":7.5,"customform":107,"department":7,"ismultishipto":true,"item":[{"addressee":"Polaroid Fotobar","addr1":"6000 Glades Road #1032C","attention":"Polaroid Fotobar","city":"Boca Raton","country":"US","custcol_produce_in_store":"F","custcol_store_pickup":"T","description":"5x7 Sublimated White Metal - In Store","isclosed":"F","isresidential":"F","isestimate":"F","istaxable":"T","item":"3488","location":"7","price":-1,"quantity":4,"rate":25,"shipmethod":10,"state":"FL","zip":"33431"},{"addressee":"Polaroid Fotobar","addr1":"6000 Glades Road #1032C","attention":"Polaroid Fotobar","city":"Boca Raton","country":"US","custcol_produce_in_store":"F","custcol_store_pickup":"T","description":"5x7 Sublimated Clear Metal - In Store","isclosed":"F","isresidential":"F","isestimate":"F","istaxable":"T","item":"3485","location":"7","price":-1,"quantity":1,"rate":25,"shipmethod":10,"state":"FL","zip":"33431"},{"addressee":"Beatriz Rios","addr1":"Polaroid Fotobar - F219447","addr2":"6000 Glades Road #1032C","attention":"Beatriz Rios","city":"Boca Raton","country":"US","custcol_image_url":"http:\/\/www.polaroidfotobar.com\/pdf\/219447\/1441361\/8382e095\/1441361.pdf","custcol_page_count":1,"custcol_store_pickup":true,"custcol162":1,"description":"5\"x7\" White Metal Print with easel","isclosed":"F","isresidential":"F","isestimate":"F","istaxable":"T","item":3210,"location":1,"phone":573183056134,"price":-1,"quantity":1,"rate":25,"shipmethod":2889,"state":"FL","zip":33431,"subtotal":25,"custbody_comments":"Image Quality: High - 215"}],"leadsource":2,"location":7,"orderstatus":"B","paymentmethod":8,"recordtype":"salesorder","shipaddress":"Polaroid Fotobar\nPolaroid Fotobar\n6000 Glades Road #1032C\nBoca Raton FL 33431","shipcomplete":"T","shipmethod":10,"shipdate":"02\/23\/2015","taxtotal":7.5,"total":150,"trandate":"02\/23\/2015"},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F192629","firstname":"Beatriz","lastname":"Rios","email":"beatrizelena77@yahoo.com","isperson":true,"custentity_fotomail":"beatriz192629@myfotobar.com","custentitycustomer_department":7,"recordtype":"customer","entitystatus":13,"globalsubscriptionstatus":1,"leadsource":2,"_source":"Fotobar Store 10"}}';

echo( encrypt($xxx));
die();

try{

	/** FIXES
	 Removed:
	 Backslashes from dates
	 "_itemlocation":"corporate"

	*/

	//Use GC
	//$sJson = '{"order":{"_source":"Fotobar Store 2","giftcertificateitem":[{"giftcertcode":"store405"}],"location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F74831","trandate":"03\/27\/2014","taxtotal":3.96,"taxrate":6,"shippingcost":0,"handlingcost":0,"discounttotal":0,"total":69.96,"pnrefnum":false,"paymentmethod":"","item":[{"shipmethod":10,"description":"Orange Shadowbox Polaroid 3.5 x 4.25","item":1197,"quantity":6,"rate":11,"subtotal":66,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":2}],"shipdate":"04\/01\/2014","customform":129,"ismultishipto":false,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F73242","firstname":"Jen","lastname":"Stone","email":"roger.williams@successories.com","isperson":true,"custentity_fotomail":"jen73242@myfotobar.com","_source":"Fotobar Store 2","addressee":"","custentitycustomer_department":2}}';

	// Buy GC
	//$sJson = '{"order":{"_source":"Fotobar Store 2","location":2,"department":2,"leadsource":2,"custbody_order_source":28,"ccprocessor":1,"custbody_order_source_id":"F74831","trandate":"03\/27\/2014","taxtotal":3.96,"taxrate":6,"shippingcost":0,"handlingcost":0,"discounttotal":0,"total":69.96,"pnrefnum":false,"paymentmethod":"","item":[{"giftcertrecipientname":"Roger Willliams","giftcertrecipientemail":"roger.williams@successories.com","giftcertnumber":"ROGERTEST","giftcertmessage":"Happy Birthday","giftcertfrom":"Roger Williams","shipmethod":10,"description":"Gift Certificate","item":1119,"quantity":1,"rate":50,"subtotal":50,"custcol_produce_in_store":false,"custcol_store_pickup":false,"discounttotal":0,"location":2},{"shipmethod":10,"description":"Orange Shadowbox Polaroid 3.5 x 4.25","item":1197,"quantity":6,"rate":11,"subtotal":66,"custcol_produce_in_store":true,"custcol_store_pickup":false,"discounttotal":0,"location":2}],"shipdate":"04\/01\/2014","customform":129,"ismultishipto":false,"custbody_web_discount_code":""},"customer":{"custentity_customer_source":3,"custentity_customer_source_id":"F73242","firstname":"Jen","lastname":"Stone","email":"roger.williams@successories.com","isperson":true,"custentity_fotomail":"jen73242@myfotobar.com","_source":"Fotobar Store 2","addressee":"","custentitycustomer_department":2}}';



	$pdo = new PDO('mysql:host='.SYSTEM_DB_HOST.';dbname='.SYSTEM_DB_DATABASE, SYSTEM_DB_USER, SYSTEM_DB_PASS);
	$stmt = $pdo->prepare('INSERT INTO fotobar_order_queue (customer_activa_id, order_activa_id, order_json) VALUES(:customer_activa_id, :order_activa_id, :order_json)');
	//$stmt->execute( array('customer_activa_id' => $aOrderData->customer->custentity_customer_source_id, ':order_activa_id' => $aOrderData->order->custbody_order_source_id, ':order_json' => encrypt( $sJson ) ) );
	$stmt->execute( array('customer_activa_id' => "F".rand(10000,90000), ':order_activa_id' => "FD".rand(10000,90000), ':order_json' => encrypt( $sJson ) ) );

} catch(PDOException $e) {
	echo 'Error: ' . $e->getMessage();
}



function encrypt( $sData ){

	$td = mcrypt_module_open('rijndael-128', '', 'ecb', '');
	$iv = mcrypt_create_iv( mcrypt_enc_get_iv_size( $td ), MCRYPT_RAND );
	$ks = mcrypt_enc_get_key_size( $td );
	$key = substr( md5( SECRET_KEY ), 0, $ks );
	mcrypt_generic_init( $td, $key, $iv );
	$encrypted = mcrypt_generic( $td, $sData );
	mcrypt_generic_deinit( $td );
	mcrypt_module_close( $td );

	return( base64_encode( $encrypted ) );
}

function decrypt( $sData ){

	$td = mcrypt_module_open( 'rijndael-128', '', 'ecb', '' );
	$iv = mcrypt_create_iv(mcrypt_enc_get_iv_size( $td ), MCRYPT_RAND);
	$ks = mcrypt_enc_get_key_size( $td );
	$key = substr( md5( SECRET_KEY ), 0, $ks );

	mcrypt_generic_init( $td, $key, $iv );
	$decrypted = mdecrypt_generic( $td, base64_decode( $sData ) );
	$decrypted = rtrim($decrypted,"\0");
	mcrypt_generic_deinit( $td );
	mcrypt_module_close( $td );

	return( $decrypted );

}

